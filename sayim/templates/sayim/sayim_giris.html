{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Stok SayÄ±m GiriÅŸi | {{ sayim_emri.ad }}</title>
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <style>
Â  Â  Â  Â  /* SADE VE Ä°ÅLEVSEL TEMEL STÄ°LLER */
Â  Â  Â  Â  body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
Â  Â  Â  Â  input[type="text"], input[type="number"], button, select { padding: 10px; margin: 5px 0; display: block; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
Â  Â  Â  Â  .info-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; background-color: white; border-radius: 4px; }
Â  Â  Â  Â  .message.success { color: green; font-weight: bold; }
Â  Â  Â  Â  .message.error { color: red; font-weight: bold; }
Â  Â  Â  Â  hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
Â  Â  Â  Â  .flex-container { display: flex; gap: 10px; margin-bottom: 10px; }
Â  Â  Â  Â  .flex-container > div { flex: 1; }
Â  Â  Â  Â  .section-header { margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
Â  Â  Â  Â  button { cursor: pointer; background-color: #007bff; color: white; border: none; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ek Durum Stil TanÄ±mlarÄ± */
Â  Â  Â  Â  #urun_bilgi_alani.status-found { border-left: 5px solid green; padding-left: 10px; }
Â  Â  Â  Â  #urun_bilgi_alani.status-missing { border-left: 5px solid red; padding-left: 10px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Toplu SayÄ±m Tablosu Stil GÃ¼ncellemesi */
Â  Â  Â  Â  #sonuc_tablosu th, #sonuc_tablosu td { border: 1px solid #ddd; padding: 5px; }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="info-box">
Â  Â  Â  Â  <h3>SayÄ±m Bilgileri</h3>
Â  Â  Â  Â  <p>SayÄ±m Emri: <strong>{{ sayim_emri.ad }}</strong> (ID: {{ sayim_emri.pk }})</p>
Â  Â  Â  Â  <p>Depo Kodu: <strong id="depo_kodu_gizli">{{ depo_kodu }}</strong></p>
Â  Â  Â  Â  <p>Personel: <strong id="personel_adi_gizli">{{ personel_adi }}</strong></p>
Â  Â  Â  Â  <a href="{% url 'raporlama_onay' sayim_emri_id=sayim_emri.pk %}">Raporlama ve Onay EkranÄ±na Git</a>
Â  Â  </div>

Â  Â  <h2>1. Stok Arama ve Veri GiriÅŸi</h2>
Â  Â Â 
Â  Â  <div class="info-box">
Â  Â  Â  Â  <h3 class="section-header">A. Seri No / Barkod GiriÅŸi</h3>
Â  Â  Â  Â  <input type="text" id="barkod_input" placeholder="Seri No/Barkodu buraya girin (ENTER)">
Â  Â  Â  Â  <p style="font-size: 0.9em; color: gray;">(Otomatik arama iÃ§in ENTER tuÅŸunu kullanÄ±n.)</p>
Â  Â  </div>

Â  Â  <hr>
Â  Â Â 
Â  Â  <h2>1.B. Yapay Zeka (Gemini/OCR) GiriÅŸi</h2>

Â  Â  <div class="info-box">
Â  Â  Â  Â  <div class="flex-container">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="select-file-btn" type="button">ğŸ“ Dosyadan SeÃ§</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="camera-btn" type="button" style="background-color: #ffc107; color: black;">ğŸ“· KamerayÄ± AÃ§</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input type="file" id="image-input" accept="image/*" style="display: none;">

Â  Â  Â  Â  <p style="font-size: 0.9em; color: gray; margin-top: 10px;">(Gemini Vision ile **Ã§oklu etiket** okuma.)</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <p id="gemini_mesaj" class="message"></p>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="toplu_sonuc_alani" style="margin-top: 20px; border: 1px solid #007bff; padding: 15px; border-radius: 4px; display: none;">
Â  Â  Â  Â  <h3 class="section-header" style="border-bottom: none;">Okunan Toplu Etiketler (<span id="toplu_sonuc_sayisi">0</span> Adet)</h3>
Â  Â  Â  Â  <table id="sonuc_tablosu" style="width: 100%; font-size: 0.9em;">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 30%; text-align: left;">Barkod / Kod</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 20%; text-align: right;">Miktar</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 40%; text-align: left;">Parti/Renk</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%;">Ä°ÅŸlem</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <hr>
Â  Â  <h3 class="section-header">Veya DetaylÄ± GiriÅŸ</h3>
Â  Â Â 
Â  Â  <div id="stok_kod_container">
Â  Â  Â  Â  <input type="text" id="stok_kod_input" placeholder="Stok Kodu">
Â  Â  </div>
Â  Â  <div id="parti_no_container">
Â  Â  Â  Â  <input type="text" id="parti_no_input" placeholder="Parti No (Opsiyonel)">
Â  Â  </div>
Â  Â  <div id="renk_container">
Â  Â  Â  Â  <input type="text" id="renk_input" placeholder="Renk/Varyant (Opsiyonel)">
Â  Â  </div>
Â  Â  <button id="ara-btn">Stok Ara</button>

Â  Â  <div id="urun_bilgi_alani" style="margin-top: 15px;">
Â  Â  Â  Â  <p>ÃœrÃ¼n: <strong id="urun_bilgi">Stok kodu veya Barkod girin...</strong></p>
Â  Â  Â  Â  <p>Sistem StoÄŸu: <strong id="sistem_stok_goster">0.00</strong></p>
Â  Â  Â  Â  <p>Son SayÄ±m: <strong id="last_sayim_goster">Bilinmiyor</strong></p>
Â  Â  </div>

Â  Â  <hr>

Â  Â  <h2>2. SayÄ±m GiriÅŸi</h2>
Â  Â Â 
Â  Â  <input type="number" id="miktar_input" placeholder="SayÄ±m MiktarÄ± (Ã–rn: 1.00)">
Â  Â  <button id="sayim_kaydet_btn" style="background-color: #28a745;">KAYDET (**ENTER**)</button>
Â  Â  <p class="message" id="kayit_mesaji"></p>
Â  Â  <p>Yeni Toplam SayÄ±m: <strong id="yeni_toplam_goster">0.00</strong></p>


<script>
Â  Â  // **********************************************
Â  Â  // JS FONKSÄ°YONLARI GLOBAL KAPSAMA TAÅINDI
Â  Â  // **********************************************

Â  Â  // --- TEMEL TANIMLAR (Global Kapsamda EriÅŸilebilir OlmalÄ±) ---
Â  Â  let DEPO_KODU = 'YOK';
Â  Â  let currentStokKod = '';
Â  Â  let currentPartiNo = 'YOK';
Â  Â  let currentRenk = 'YOK';
Â  Â  let currentSeriNo = 'YOK';
    
    // â­ KRÄ°TÄ°K Ã‡Ã–ZÃœM: SAYIM EMRÄ° ID'sini doÄŸrudan template tag'inden alÄ±yoruz.
    // Bu, NoReverseMatch hatasÄ±nÄ± Ã§Ã¶zer.
    const SAYIM_EMRI_ID = "{{ sayim_emri.pk }}"; 
Â  Â Â 
Â  Â  // CSRF Token Fonksiyonu (Django POST iÃ§in kritik)
Â  Â  function getCookie(name) {
Â  Â  Â  Â  let cookieValue = null;
Â  Â  Â  Â  if (document.cookie && document.cookie !== '') {
Â  Â  Â  Â  Â  Â  const cookies = document.cookie.split(';');
Â  Â  Â  Â  Â  Â  for (let i = 0; i < cookies.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const cookie = cookies[i].trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (cookie.startsWith(name + '=')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return cookieValue;
Â  Â  }

Â  Â  // --- 1. VARYANT DROPDOWN OLUÅTURMA Ä°ÅLEVÄ° (Global) ---
Â  Â  function updateVariantInputs(data) {
Â  Â  Â  Â  const partiNoContainer = document.getElementById('parti_no_container');
Â  Â  Â  Â  const renkContainer = document.getElementById('renk_container');

Â  Â  Â  Â  const createInput = (id, placeholder, value) =>Â 
Â  Â  Â  Â  Â  Â  `<input type="text" id="${id}" placeholder="${placeholder}" value="${value || ''}">`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Parti No iÃ§in
Â  Â  Â  Â  if (data.parti_varyantlar && data.parti_varyantlar.length > 0) {
Â  Â  Â  Â  Â  Â  let options = data.parti_varyantlar.map(p => `<option value="${p}">${p}</option>`).join('');
Â  Â  Â  Â  Â  Â  const selectedParti = data.parti_no || data.parti_varyantlar[0];
Â  Â  Â  Â  Â  Â  options = `<option value="${selectedParti}" selected>${selectedParti}</option>` + options.replace(`<option value="${selectedParti}">`, '').replace(`</option>`, '');
Â  Â  Â  Â  Â  Â  partiNoContainer.innerHTML = `<select id="parti_no_input">${options}</select>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  partiNoContainer.innerHTML = createInput('parti_no_input', 'Parti No (Opsiyonel)', data.parti_no);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Renk/Varyant iÃ§in
Â  Â  Â  Â  if (data.renk_varyantlar && data.renk_varyantlar.length > 0) {
Â  Â  Â  Â  Â  Â  let options = data.renk_varyantlar.map(r => `<option value="${r}">${r}</option>`).join('');
Â  Â  Â  Â  Â  Â  const selectedRenk = data.renk || data.renk_varyantlar[0];
Â  Â  Â  Â  Â  Â  options = `<option value="${selectedRenk}" selected>${selectedRenk}</option>` + options.replace(`<option value="${selectedRenk}">`, '').replace(`</option>`, '');
Â  Â  Â  Â  Â  Â  renkContainer.innerHTML = `<select id="renk_input">${options}</select>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  renkContainer.innerHTML = createInput('renk_input', 'Renk/Varyant (Opsiyonel)', data.renk);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  setupAutoSearchListeners();Â 
Â  Â  }

Â  Â  // --- 2. AKILLI ARAMA FONKSÄ°YONU (Global) ---
Â  Â  function akilliStokAra(seriNo, stokKod, partiNo, renk, depoKod, barkodHamVeri = '') {
Â  Â  Â  Â  const urunBilgiAlani = document.getElementById('urun_bilgi_alani');
Â  Â  Â  Â  const stokKodInput = document.getElementById('stok_kod_input');

Â  Â  Â  Â  document.getElementById('urun_bilgi').innerText = 'Arama yapÄ±lÄ±yor...';
Â  Â  Â  Â  document.getElementById('sistem_stok_goster').innerText = '0.00';
Â  Â  Â  Â  document.getElementById('last_sayim_goster').innerText = 'Bilinmiyor';
Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = '';Â 
Â  Â  Â  Â  urunBilgiAlani.classList.remove('status-found', 'status-missing');Â 
Â  Â  Â  Â  urunBilgiAlani.classList.add('status-default');Â 

Â  Â  Â  Â  const params = new URLSearchParams({
Â  Â  Â  Â  Â  Â  seri_no: seriNo || 'YOK',
Â  Â  Â  Â  Â  Â  stok_kod: stokKod || 'YOK',
Â  Â  Â  Â  Â  Â  parti_no: partiNo || 'YOK',
Â  Â  Â  Â  Â  Â  renk: renk || 'YOK',
Â  Â  Â  Â  Â  Â  depo_kod: depoKod,
Â  Â  Â  Â  Â  Â  barkod_ham_veri: barkodHamVeri || 'YOK'
Â  Â  Â  Â  });

Â  Â  Â  Â  // NOT: URL tag'i Django'nun AJAX uÃ§ noktasÄ±na doÄŸru gitmelidir.
Â  Â  Â  Â  fetch(`{% url 'ajax_akilli_stok_ara' %}?${params.toString()}`)Â 
Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Sunucu HatasÄ± (${response.status}). YanÄ±t JSON deÄŸil.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return response.json();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('urun_bilgi').innerText = data.urun_bilgi;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('last_sayim_goster').innerText = data.last_sayim;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Global deÄŸiÅŸkenleri gÃ¼ncelle
Â  Â  Â  Â  Â  Â  Â  Â  currentStokKod = data.stok_kod;
Â  Â  Â  Â  Â  Â  Â  Â  currentPartiNo = data.parti_no;
Â  Â  Â  Â  Â  Â  Â  Â  currentRenk = data.renk;
Â  Â  Â  Â  Â  Â  Â  Â  currentSeriNo = seriNo;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const partiNoElement = document.getElementById('parti_no_input');
Â  Â  Â  Â  Â  Â  Â  Â  const renkElement = document.getElementById('renk_input');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (data.found) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tam eÅŸleÅŸme bulundu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stokKodInput.value = data.stok_kod;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sistem_stok_goster').innerText = data.sistem_stok;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urunBilgiAlani.classList.add('status-found');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateVariantInputs({ parti_no: data.parti_no, renk: data.renk });

Â  Â  Â  Â  Â  Â  Â  Â  } else if (data.parti_varyantlar && data.parti_varyantlar.length > 0 || data.renk_varyantlar && data.renk_varyantlar.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Stok koduna gÃ¶re varyantlar bulundu (Dropdown'a dÃ¶nÃ¼ÅŸtÃ¼r)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStokKod = data.stok_kod;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentPartiNo = partiNo;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRenk = renk;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urunBilgiAlani.classList.add('status-default');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateVariantInputs(data);

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // EÅŸleÅŸme yok
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urunBilgiAlani.classList.add('status-missing');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateVariantInputs({ parti_no: partiNo, renk: renk });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // GÃ¼ncel Dropdown/Input deÄŸerleriyle current deÄŸerleri senkronize et
Â  Â  Â  Â  Â  Â  Â  Â  currentPartiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK';
Â  Â  Â  Â  Â  Â  Â  Â  currentRenk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';

Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('urun_bilgi').innerText = `Arama HatasÄ±: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  urunBilgiAlani.classList.add('status-missing');Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- 3. GEMINI OKU FONKSÄ°YONU (Toplu SonuÃ§larÄ± Ä°ÅŸler) ---
Â  Â  function geminiOku(file) {
Â  Â  Â  Â  const SAYIM_EMRI_ID = "{{ sayim_emri.pk }}";
Â  Â  Â  Â  const topluSonucAlani = document.getElementById('toplu_sonuc_alani');
Â  Â  Â  Â  const sonucTablosuBody = document.getElementById('sonuc_tablosu').getElementsByTagName('tbody')[0];
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('gemini_mesaj').className = 'message';
Â  Â  Â  Â  document.getElementById('gemini_mesaj').innerText = 'ğŸ“¸ GÃ¶rsel yÃ¼kleniyor ve Gemini ile analiz ediliyor... Bu biraz sÃ¼rebilir.';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ã–nceki sonuÃ§larÄ± ve alanÄ± temizle
Â  Â  Â  Â  topluSonucAlani.style.display = 'none';
Â  Â  Â  Â  sonucTablosuBody.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  formData.append('image_file', file);
Â  Â  Â  Â  formData.append('sayim_emri_id', SAYIM_EMRI_ID);
Â  Â  Â  Â  formData.append('depo_kodu', DEPO_KODU);

Â  Â  Â  Â  // NOT: URL tag'i Django'nun Gemini OCR uÃ§ noktasÄ±na doÄŸru gitmelidir.
Â  Â  Â  Â  fetch('{% url "gemini_ocr_analiz" %}', {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  'X-CSRFToken': getCookie('csrftoken'),
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(res => {
Â  Â  Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // EÄŸer sunucu 404 veya 500 dÃ¶nerse, JSON yanÄ±tÄ± gelmeyebilir.
Â  Â  Â  Â  Â  Â  Â  Â  return res.json().catch(() => { throw new Error(`Sunucu HatasÄ± (${res.status}). API Key/Endpoint Kontrol Edin.`); });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return res.json();
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  if (data.success && data.results && data.results.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').className = 'message success';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').innerText = data.message;

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('toplu_sonuc_sayisi').innerText = data.count;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  data.results.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Her bir sonuÃ§ iÃ§in tabloya bir satÄ±r ekle
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = sonucTablosuBody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. HÃ¼cre: Barkod / Stok Kod
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="font-weight: bold; margin: 0;">${item.barkod !== 'YOK' ? item.barkod : item.stok_kod}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size: 0.8em; color: gray;">${item.barkod === 'YOK' ? 'Sadece Kod' : 'Barkod'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.cells[0].style.textAlign = 'left';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. HÃ¼cre: Miktar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const miktarCell = row.insertCell();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  miktarCell.innerText = item.miktar;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  miktarCell.style.fontWeight = 'bold';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. HÃ¼cre: Parti/Renk
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 0;">P: ${item.parti_no}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin: 0;">R: ${item.renk}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.cells[2].style.textAlign = 'left';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. HÃ¼cre: Ä°ÅŸlem Butonu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const islemBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  islemBtn.innerText = 'SEÃ‡';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  islemBtn.style.padding = '5px 8px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  islemBtn.style.width = 'auto';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  islemBtn.style.backgroundColor = '#17a2b8';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SeÃ§ butonuna tÄ±klanÄ±nca tekli arama alanlarÄ±nÄ± doldur ve otomatik ara
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  islemBtn.onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('barkod_input').value = item.barkod !== 'YOK' ? item.barkod : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('stok_kod_input').value = item.stok_kod !== 'YOK' ? item.stok_kod : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('miktar_input').value = item.miktar;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Parti ve Renk alanlarÄ±nÄ± bulup doldur (Dropdown veya Input olabilir)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const partiInput = document.getElementById('parti_no_input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (partiInput) partiInput.value = item.parti_no !== 'YOK' ? item.parti_no : partiInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const renkInput = document.getElementById('renk_input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (renkInput) renkInput.value = item.renk !== 'YOK' ? item.renk : renkInput.value;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Otomatik AramayÄ± BaÅŸlat (Barkod veya Stok Koduna gÃ¶re)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  akilliStokAra(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.barkod !== 'YOK' ? item.barkod : 'YOK',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.stok_kod !== 'YOK' ? item.stok_kod : 'YOK',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.parti_no,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.renk,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DEPO_KODU,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.barkod // Barkod ham verisi olarak gÃ¶nder
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('miktar_input').focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SeÃ§ilen satÄ±rÄ± vurgula (isteÄŸe baÄŸlÄ±)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Array.from(sonucTablosuBody.rows).forEach(r => r.style.backgroundColor = '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.style.backgroundColor = '#e6f7ff';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.insertCell().appendChild(islemBtn);

Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  topluSonucAlani.style.display = 'block';

Â  Â  Â  Â  Â  Â  } else if (data.success && data.results && data.results.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').innerText = 'âŒ YZ Analizi: GÃ¶rselde geÃ§erli bir etiket verisi okunamadÄ±.';
Â  Â  Â  Â  Â  Â  Â  Â  topluSonucAlani.style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').innerText = `âŒ YZ HatasÄ±: ${data.message || 'Analiz baÅŸarÄ±sÄ±z oldu.'}`;
Â  Â  Â  Â  Â  Â  Â  Â  topluSonucAlani.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').className = 'message error';
Â  Â  Â  Â  Â  Â  document.getElementById('gemini_mesaj').innerText = `Kritik Hata: Analiz servisine ulaÅŸÄ±lamadÄ±. ${error.message}`;
Â  Â  Â  Â  Â  Â  topluSonucAlani.style.display = 'none';
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- 4. KONUM ALMA FONKSÄ°YONU (Global ve Asenkron) ---
Â  Â  function getCurrentLocation() {
Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  resolve({ latitude: 'YOK', longitude: 'YOK', precision: 0, error: 'Geolocation not supported' });
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Konum bilgisini 10 saniye iÃ§inde almaya Ã§alÄ±ÅŸ
Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  (position) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latitude: position.coords.latitude,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  longitude: position.coords.longitude,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precision: position.coords.accuracy, // Hassasiyet (metre)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  error: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ä°zin verilmezse (1), zaman aÅŸÄ±mÄ±na uÄŸrarsa (3) vb.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({ latitude: 'YOK', longitude: 'YOK', precision: 0, error: error.message || 'Location permission denied or timed out' });
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  enableHighAccuracy: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeout: 10000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maximumAge: 0
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  });
Â  Â  }


Â  Â  // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---
Â  Â Â 
Â  Â  // YENÄ°: TÃ¼m arama inputlarÄ± iÃ§in ENTER/CHANGE dinleyicisi
Â  Â  function setupAutoSearchListeners() {
Â  Â  Â  Â  const barkodInput = document.getElementById('barkod_input');
Â  Â  Â  Â  const allInputs = [barkodInput, document.getElementById('stok_kod_input'),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('parti_no_input'),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('renk_input')];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Dinleyicileri temizle (Ã‡ift tetiklemeyi Ã¶nlemek iÃ§in)
Â  Â  Â  Â  allInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  if(input) {
Â  Â  Â  Â  Â  Â  Â  Â  input.removeEventListener('keydown', handleSearchEnter);
Â  Â  Â  Â  Â  Â  Â  Â  input.removeEventListener('change', handleSearchEnter);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Yeni dinleyicileri kur
Â  Â  Â  Â  allInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  if (input) {
Â  Â  Â  Â  Â  Â  Â  Â  if(input.tagName === 'INPUT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('keydown', handleSearchEnter);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (input.tagName === 'SELECT') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('change', handleSearchEnter);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function handleSearchEnter(event) {
Â  Â  Â  Â  if (event.type === 'keydown' && event.key !== 'Enter') {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (event.type === 'keydown') {
Â  Â  Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  const stokKodInput = document.getElementById('stok_kod_input');
Â  Â  Â  Â  const barkodInput = document.getElementById('barkod_input');
Â  Â  Â  Â  const partiNoElement = document.getElementById('parti_no_input');
Â  Â  Â  Â  const renkElement = document.getElementById('renk_input');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const currentPartiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK';
Â  Â  Â  Â  const currentRenk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';
Â  Â  Â  Â  const currentStokKod = stokKodInput.value.toUpperCase().trim();
Â  Â  Â  Â  const currentSeriNo = barkodInput.value.toUpperCase().trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (event.target.id === 'barkod_input') {
Â  Â  Â  Â  Â  Â akilliStokAra(currentSeriNo, 'YOK', 'YOK', 'YOK', DEPO_KODU, currentSeriNo);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â akilliStokAra('YOK', currentStokKod, currentPartiNo, currentRenk, DEPO_KODU, 'YOK');
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // 3. KAMERA/DOSYA BUTONLARI (BÃ¶lÃ¼m B - Gemini/OCR) Dinleyicileri
Â  Â  function setupGeminiListeners() {
Â  Â  Â  Â  const imageInput = document.getElementById('image-input');
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('select-file-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  imageInput.removeAttribute('capture');Â 
Â  Â  Â  Â  Â  Â  imageInput.click();
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('camera-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  imageInput.setAttribute('capture', 'environment');Â 
Â  Â  Â  Â  Â  Â  imageInput.click();
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById('image-input').addEventListener('change', function() {
Â  Â  Â  Â  Â  Â  if (this.files.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  geminiOku(this.files[0]);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  this.removeAttribute('capture');
Â  Â  Â  Â  });
Â  Â  }


Â  Â  // DOM YÃ¼klendiÄŸinde BaÅŸlat
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  // --- TEMEL TANIMLARI GÃœNCELLE ---
Â  Â  Â  Â  DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
Â  Â  Â  Â  // â­ SAYIM_EMRI_ID'nin deÄŸeri global scope'da {{ sayim_emri.pk }} olarak atanmÄ±ÅŸtÄ±r.
Â  Â  Â  Â  const PERSONEL_ADI = document.getElementById('personel_adi_gizli').innerText.trim();
Â  Â  Â  Â  const miktarInput = document.getElementById('miktar_input');

Â  Â  Â  Â  // Olay Dinleyicilerini BaÅŸlat
Â  Â  Â  Â  setupGeminiListeners();
Â  Â  Â  Â  setupAutoSearchListeners();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 4. DetaylÄ± Arama DÃ¼ÄŸmesi
Â  Â  Â  Â  document.getElementById('ara-btn').addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  const partiNoElement = document.getElementById('parti_no_input');
Â  Â  Â  Â  Â  Â  const renkElement = document.getElementById('renk_input');
Â  Â  Â  Â  Â  Â  const stokKodInput = document.getElementById('stok_kod_input');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const stokKod = stokKodInput.value.toUpperCase().trim();
Â  Â  Â  Â  Â  Â  const partiNo = partiNoElement ? partiNoElement.value.toUpperCase().trim() : 'YOK';Â 
Â  Â  Â  Â  Â  Â  const renk = renkElement ? renkElement.value.toUpperCase().trim() : 'YOK';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  akilliStokAra('YOK', stokKod, partiNo, renk, DEPO_KODU, 'YOK');
Â  Â  Â  Â  });

Â  Â  Â  Â  // 5. SayÄ±m Kaydetme DÃ¼ÄŸmesi
Â  Â  Â  Â  document.getElementById('sayim_kaydet_btn').addEventListener('click', async function() { // ASYNC yapÄ±ldÄ±
Â  Â  Â  Â  Â  Â  const miktar = miktarInput.value;

Â  Â  Â  Â  Â  Â  if (!currentStokKod || currentStokKod === 'YOK') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = 'LÃ¼tfen Ã¶nce geÃ§erli bir stok bulun.';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (parseFloat(miktar) <= 0 || isNaN(parseFloat(miktar))) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = 'Miktar geÃ§erli bir sayÄ± olmalÄ±dÄ±r (> 0).';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // â­ KRÄ°TÄ°K: Konum Bilgisini Asenkron Olarak Al
Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = 'Konum alÄ±nÄ±yor...';
Â  Â  Â  Â  Â  Â  const locationData = await getCurrentLocation();
Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = ''; // MesajÄ± temizle

Â  Â  Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  Â  Â  Â  stok_kod: currentStokKod,
Â  Â  Â  Â  Â  Â  Â  Â  parti_no: currentPartiNo,
Â  Â  Â  Â  Â  Â  Â  Â  renk: currentRenk,
Â  Â  Â  Â  Â  Â  Â  Â  miktar: miktar,
Â  Â  Â  Â  Â  Â  Â  Â  depo_kod: DEPO_KODU,
Â  Â  Â  Â  Â  Â  Â  Â  personel_adi: PERSONEL_ADI,
Â  Â  Â  Â  Â  Â  Â  Â  // YENÄ° ALANLAR: Konum verisini ekle
Â  Â  Â  Â  Â  Â  Â  Â  lat: locationData.latitude,
Â  Â  Â  Â  Â  Â  Â  Â  lon: locationData.longitude,
Â  Â  Â  Â  Â  Â  Â  Â  loc_hata: locationData.error // Konum alÄ±namadÄ±ysa hata sebebi
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // NOT: SAYIM KAYDETME URL'si buraya eklendi
Â  Â  Â  Â  Â  Â  fetch(`{% url 'ajax_sayim_kaydet' sayim_emri_id=SAYIM_EMRI_ID %}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Content-Type": "application/json",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'X-CSRFToken': getCookie('csrftoken'),Â 
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(data)
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Konum alÄ±namadÄ±ysa uyarÄ± ver
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (locationData.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = `âš ï¸ SayÄ±m kaydedildi. Ancak konum alÄ±namadÄ±: ${locationData.error}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message success';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = data.message;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('yeni_toplam_goster').innerText = data.yeni_miktar;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  miktarInput.value = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = data.message;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').className = 'message error';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('kayit_mesaji').innerText = `Kritik KayÄ±t HatasÄ±: Sunucuya ulaÅŸÄ±lamadÄ±. ${error.message}`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // Ä°lk yÃ¼klemede arama yap
Â  Â  Â  Â  akilliStokAra('YOK', 'YOK', 'YOK', 'YOK', DEPO_KODU, 'YOK');
Â  Â  });
</script>
</body>
</html>