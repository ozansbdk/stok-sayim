{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Stok SayÄ±m GiriÅŸi | {{ sayim_emri.ad }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* SADE VE Ä°ÅLEVSEL TEMEL STÄ°LLER */
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background-color: #f4f7f6; }
        input[type="text"], input[type="number"], button, select { padding: 10px; margin: 5px 0; display: block; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .info-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; background-color: white; border-radius: 4px; }
        .message { padding: 10px; margin-top: 10px; border-radius: 4px; text-align: center; }
        .message.success { color: green; background-color: #e6ffed; border: 1px solid green; }
        .message.error { color: red; background-color: #ffe6e6; border: 1px solid red; }
        .message.warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba;}
        hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
        .flex-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .flex-container > div { flex: 1; }
        .section-header { margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; font-weight: bold; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Ek Durum Stil TanÄ±mlarÄ± */
        #urun_bilgi_alani.status-found { border-left: 5px solid green; padding-left: 10px; background-color: #f0fff0; }
        #urun_bilgi_alani.status-missing { border-left: 5px solid red; padding-left: 10px; background-color: #fff0f0; }
        #urun_bilgi_alani.status-variants { border-left: 5px solid orange; padding-left: 10px; background-color: #fff8e1; }
        #urun_bilgi_alani.status-default { border-left: 5px solid #ccc; padding-left: 10px; background-color: #f9f9f9;}
        
        /* Toplu SayÄ±m Tablosu Stil GÃ¼ncellemesi */
        #sonuc_tablosu { border-collapse: collapse; margin-top: 10px; }
        #sonuc_tablosu th, #sonuc_tablosu td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; }
        #sonuc_tablosu th { background-color: #f2f2f2; }
        #sonuc_tablosu tbody tr:hover { background-color: #e6f7ff; }
        #sonuc_tablosu button { font-size: 0.8em; padding: 4px 6px; }

        /* UyarÄ± MesajÄ± Stili */
        #farkli_depo_uyari_alani { margin-top: 5px; font-size: 0.9em; font-weight: bold; color: #dc3545; }

    </style>
</head>
<body>
    <div class="info-box">
        <h3>SayÄ±m Bilgileri</h3>
        <p>SayÄ±m Emri: <strong>{{ sayim_emri.ad }}</strong> (ID: {{ sayim_emri_id }})</p>
        <p>Depo Kodu: <strong id="depo_kodu_gizli">{{ depo_kodu }}</strong></p>
        <p>Personel: <strong id="personel_adi_gizli">{{ personel_adi }}</strong></p>
        <a href="{% url 'raporlama_onay' sayim_emri_id=sayim_emri_id %}">Raporlama ve Onay EkranÄ±na Git</a>
    </div>

    <h2>1. Stok Arama ve Veri GiriÅŸi</h2>
    
    <div class="info-box">
        <h3 class="section-header">A. Seri No / Barkod GiriÅŸi</h3>
        <input type="text" id="barkod_input" placeholder="Seri No/Barkodu buraya girin (ENTER)">
        <p style="font-size: 0.9em; color: gray;">(Otomatik arama iÃ§in ENTER tuÅŸunu kullanÄ±n.)</p>
    </div>

    <hr>
    
    <h2>1.B. Yapay Zeka (Gemini/OCR) GiriÅŸi</h2>

    <div class="info-box">
        <div class="flex-container">
            <div>
                <button id="select-file-btn" type="button" {% if not gemini_available %}disabled title="Gemini API anahtarÄ± ayarlanmamÄ±ÅŸ"{% endif %}>ğŸ“ Dosyadan SeÃ§</button>
            </div>
            <div>
                <button id="camera-btn" type="button" style="background-color: #ffc107; color: black;" {% if not gemini_available %}disabled title="Gemini API anahtarÄ± ayarlanmamÄ±ÅŸ"{% endif %}>ğŸ“· KamerayÄ± AÃ§</button>
            </div>
        </div>
        
        <input type="file" id="image-input" accept="image/*" style="display: none;">

        <p style="font-size: 0.9em; color: gray; margin-top: 10px;">(Gemini Vision ile **Ã§oklu etiket** okuma.)</p>
        {% if not gemini_available %}
            <p class="message warning" style="margin-top:10px; text-align:left;">âš ï¸ Gemini Ã¶zelliÄŸi ÅŸu anda aktif deÄŸil. LÃ¼tfen API anahtarÄ±nÄ± kontrol edin.</p>
        {% endif %}
        
        <p id="gemini_mesaj" class="message" style="display: none;"></p> <!-- BaÅŸlangÄ±Ã§ta gizli -->
    </div>
    
    <div id="toplu_sonuc_alani" style="margin-top: 20px; border: 1px solid #007bff; padding: 15px; border-radius: 4px; display: none;">
        <h3 class="section-header" style="border-bottom: none;">Okunan Toplu Etiketler (<span id="toplu_sonuc_sayisi">0</span> Adet)</h3>
        <table id="sonuc_tablosu" style="width: 100%; font-size: 0.9em;">
            <thead>
                <tr>
                    <th style="width: 30%;">Barkod / Kod</th>
                    <th style="width: 20%; text-align: right;">Miktar</th>
                    <th style="width: 40%;">Parti/Renk</th>
                    <th style="width: 10%;">Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody>
                <!-- SonuÃ§lar buraya eklenecek -->
            </tbody>
        </table>
    </div>

    <hr>
    <h3 class="section-header">Veya DetaylÄ± GiriÅŸ</h3>
    
    <div id="stok_kod_container">
        <input type="text" id="stok_kod_input" placeholder="Stok Kodu">
    </div>
    <div id="parti_no_container">
        <input type="text" id="parti_no_input" placeholder="Parti No (Opsiyonel)">
    </div>
    <div id="renk_container">
        <input type="text" id="renk_input" placeholder="Renk/Varyant (Opsiyonel)">
    </div>
    <button id="ara-btn">Stok Ara</button>

    <div id="urun_bilgi_alani" style="margin-top: 15px;" class="status-default">
        <p>ÃœrÃ¼n: <strong id="urun_bilgi">Stok kodu veya Barkod girin...</strong></p>
        <p>Sistem StoÄŸu: <strong id="sistem_stok_goster">0.00</strong></p>
        <p>Bu SayÄ±mdaki Toplam: <strong id="sayilan_stok_goster">0.00</strong></p> <!-- GÃ¼ncel sayÄ±m toplamÄ± eklendi -->
        <p>Son SayÄ±m (Genel): <strong id="last_sayim_goster">Bilinmiyor</strong></p>
        <p id="farkli_depo_uyari_alani"></p> <!-- FarklÄ± depo uyarÄ±sÄ± iÃ§in alan -->
    </div>

    <hr>

    <h2>2. SayÄ±m GiriÅŸi</h2>
    
    <input type="number" id="miktar_input" placeholder="SayÄ±m MiktarÄ± (Ã–rn: 1.00)" step="0.01"> <!-- step eklendi -->
    <button id="sayim_kaydet_btn" style="background-color: #28a745;" disabled>KAYDET (**ENTER**)</button> <!-- BaÅŸlangÄ±Ã§ta disabled -->
    <p class="message" id="kayit_mesaji" style="display:none;"></p> <!-- BaÅŸlangÄ±Ã§ta gizli -->


<script>
    // **********************************************
    // GLOBAL DEÄÄ°ÅKENLER VE TEMEL FONKSÄ°YONLAR
    // **********************************************

    let DEPO_KODU = 'YOK';
    let PERSONEL_ADI = 'MISAFIR';
    const SAYIM_EMRI_ID = "{{ sayim_emri_id }}"; // View'dan gelen garanti ID
    
    // Aktif olarak seÃ§ili/bulunan Ã¼rÃ¼nÃ¼n bilgilerini tutar
    let currentBenzersizId = null; // <-- KESÄ°N Ã‡Ã–ZÃœM Ä°Ã‡Ä°N EKLENDÄ°
    let currentStokKod = '';
    let currentPartiNo = 'YOK';
    let currentRenk = 'YOK';
    
    // DOM Elementleri (TekrarlÄ± eriÅŸimi azaltmak iÃ§in)
    let barkodInput, stokKodInput, partiNoContainer, renkContainer, araBtn, miktarInput, kaydetBtn;
    let urunBilgiAlani, urunBilgi, sistemStokGoster, sayilanStokGoster, lastSayimGoster, farkliDepoUyariAlani, kayitMesaji;
    let geminiMesaj, topluSonucAlani, topluSonucSayisi, sonucTablosuBody;
    let imageInput, selectFileBtn, cameraBtn;

    // CSRF Token Fonksiyonu
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Mesaj gÃ¶sterme fonksiyonu
    function showMessage(elementId, text, type = 'info', autoHideDelay = 5000) {
        const element = document.getElementById(elementId);
        if (!element) return;
        element.innerText = text;
        element.className = `message ${type}`; // type: success, error, warning, info
        element.style.display = 'block';

        // MesajÄ± belirli bir sÃ¼re sonra gizle (success ve info iÃ§in)
        if ((type === 'success' || type === 'info') && autoHideDelay > 0) {
            setTimeout(() => {
                element.style.display = 'none';
            }, autoHideDelay);
        }
    }
    
    // ArayÃ¼zÃ¼ sÄ±fÄ±rlama (Yeni arama Ã¶ncesi)
    function resetUIBeforeSearch() {
        urunBilgi.innerText = 'AranÄ±yor...';
        sistemStokGoster.innerText = '0.00';
        sayilanStokGoster.innerText = '0.00';
        lastSayimGoster.innerText = 'Bilinmiyor';
        farkliDepoUyariAlani.innerText = '';
        kayitMesaji.style.display = 'none';
        urunBilgiAlani.className = 'status-default'; // VarsayÄ±lan stil
        kaydetBtn.disabled = true; // Kaydet butonunu devre dÄ±ÅŸÄ± bÄ±rak
        currentBenzersizId = null; // <-- Ã–NEMLÄ°: ID'yi sÄ±fÄ±rla
    }

    // Arama sonucu arayÃ¼zÃ¼ gÃ¼ncelleme
    function updateUIAfterSearch(data) {
        urunBilgi.innerText = data.urun_bilgi || 'Bilinmeyen ÃœrÃ¼n';
        sistemStokGoster.innerText = data.sistem_stok || '0.00';
        sayilanStokGoster.innerText = data.sayilan_stok || '0.00'; // SayÄ±lan stoÄŸu gÃ¶ster
        lastSayimGoster.innerText = (data.last_sayim && data.last_sayim.tarih) ? `${data.last_sayim.tarih} (${data.last_sayim.personel})` : 'Yok';
        farkliDepoUyariAlani.innerText = data.farkli_depo_uyarisi || '';

        // Global deÄŸiÅŸkenleri gÃ¼ncelle (Arama sonucu ne olursa olsun)
        currentStokKod = data.stok_kod || 'YOK';
        currentPartiNo = data.parti_no || 'YOK';
        currentRenk = data.renk || 'YOK';
        currentBenzersizId = data.benzersiz_id || null; // <-- ID'yi gÃ¼ncelle

        if (data.found) {
            urunBilgiAlani.className = 'status-found';
            kaydetBtn.disabled = false; // ÃœrÃ¼n bulunduysa kaydetmeyi etkinleÅŸtir
            // Stok kodu inputunu doldur (barkodla arandÄ±ysa)
            if (stokKodInput.value !== data.stok_kod) stokKodInput.value = data.stok_kod;
             // Varyant inputlarÄ±nÄ± normal inputa Ã§evir (dropdown kalmasÄ±n)
             updateVariantInputs({ parti_no: data.parti_no, renk: data.renk }); 
             // Miktar alanÄ±na odaklan
             miktarInput.focus(); 
        } else if (data.parti_varyantlar?.length > 0 || data.renk_varyantlar?.length > 0) {
            urunBilgiAlani.className = 'status-variants';
            kaydetBtn.disabled = true; // Varyant seÃ§imi gerekliyse kaydetme pasif
            updateVariantInputs(data); // DropdownlarÄ± oluÅŸtur
        } else {
            urunBilgiAlani.className = 'status-missing';
            kaydetBtn.disabled = true; // BulunamadÄ±ysa kaydetme pasif
            updateVariantInputs({ parti_no: partiNo || 'YOK', renk: renk || 'YOK' }); // Normal input gÃ¶ster
        }
    }


    // **********************************************
    // 1. VARYANT INPUT/DROPDOWN YÃ–NETÄ°MÄ°
    // **********************************************
    function updateVariantInputs(data) {
        // Not: data objesi { parti_no: '..', renk: '..', parti_varyantlar: [...], renk_varyantlar: [...] } iÃ§erebilir
        
        const createInput = (id, placeholder, value) => 
            `<input type="text" id="${id}" placeholder="${placeholder}" value="${value && value !== 'YOK' ? value : ''}">`;

        const createSelect = (id, optionsList, selectedValue) => {
            let optionsHTML = `<option value="YOK" ${!selectedValue || selectedValue === 'YOK' ? 'selected' : ''}>-- SeÃ§ --</option>`; // BaÅŸlangÄ±Ã§ seÃ§eneÄŸi
             optionsHTML += optionsList.map(opt => 
                 `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`
             ).join('');
             return `<select id="${id}">${optionsHTML}</select>`;
        };
             
        // Parti No
        if (data.parti_varyantlar && data.parti_varyantlar.length > 0) {
            partiNoContainer.innerHTML = createSelect('parti_no_input', data.parti_varyantlar, data.parti_no);
        } else {
            partiNoContainer.innerHTML = createInput('parti_no_input', 'Parti No (Opsiyonel)', data.parti_no);
        }

        // Renk/Varyant
        if (data.renk_varyantlar && data.renk_varyantlar.length > 0) {
            renkContainer.innerHTML = createSelect('renk_input', data.renk_varyantlar, data.renk);
        } else {
            renkContainer.innerHTML = createInput('renk_input', 'Renk/Varyant (Opsiyonel)', data.renk);
        }
        
        // Dinamik olarak eklenen input/select iÃ§in olay dinleyicilerini yeniden kur
        setupAutoSearchListeners(); 
    }

    // **********************************************
    // 2. AKILLI STOK ARAMA (AJAX)
    // **********************************************
    function akilliStokAra(seriNo = 'YOK', stokKod = 'YOK', partiNo = 'YOK', renk = 'YOK', depoKod = DEPO_KODU) {
        resetUIBeforeSearch(); // ArayÃ¼zÃ¼ temizle

        const params = new URLSearchParams({
            seri_no: seriNo,
            stok_kod: stokKod,
            parti_no: partiNo,
            renk: renk,
            depo_kod: depoKod,
            // barkod_ham_veri artÄ±k gerekli deÄŸil gibi ama kalsÄ±n
            barkod_ham_veri: seriNo !== 'YOK' ? seriNo : 'YOK', 
            sayim_emri_id: SAYIM_EMRI_ID // SayÄ±lan miktarÄ± Ã§ekmek iÃ§in gerekli olabilir
        });

        // Backend endpoint'i
        const url = `{% url 'ajax_akilli_stok_ara' %}?${params.toString()}`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    // Sunucudan gelen hata mesajÄ±nÄ± gÃ¶stermeye Ã§alÄ±ÅŸ
                    return response.json().then(errData => {
                         throw new Error(`Sunucu HatasÄ± (${response.status}): ${errData.urun_bilgi || errData.message || 'Bilinmeyen hata'}`);
                    }).catch(() => {
                         throw new Error(`Sunucu HatasÄ± (${response.status}). YanÄ±t alÄ±namadÄ± veya JSON deÄŸil.`);
                    });
                }
                return response.json();
            })
            .then(data => {
                updateUIAfterSearch(data); // ArayÃ¼zÃ¼ gÃ¼ncelle
            })
            .catch(error => {
                console.error("AkÄ±llÄ± Arama HatasÄ±:", error);
                showMessage('kayit_mesaji', `Arama HatasÄ±: ${error.message}`, 'error');
                // ArayÃ¼zÃ¼ hata durumuna getir
                 updateUIAfterSearch({ 
                     found: false, urun_bilgi: `Arama HatasÄ±: ${error.message}`,
                     stok_kod: stokKod, parti_no: partiNo, renk: renk // Girilen deÄŸerleri koru
                 });
            });
    }

    // **********************************************
    // 3. GEMINI OCR ANALÄ°ZÄ° (AJAX POST)
    // **********************************************
    function geminiOku(file) {
        if (!GEMINI_AVAILABLE) {
            showMessage('gemini_mesaj', 'Gemini API anahtarÄ± ayarlanmadÄ±ÄŸÄ± iÃ§in bu Ã¶zellik kullanÄ±lamÄ±yor.', 'warning');
            return;
        }

        showMessage('gemini_mesaj', 'ğŸ“¸ GÃ¶rsel yÃ¼kleniyor ve Gemini ile analiz ediliyor... LÃ¼tfen bekleyin.', 'info', 0); // KapanmasÄ±n
        topluSonucAlani.style.display = 'none';
        sonucTablosuBody.innerHTML = '';
        selectFileBtn.disabled = true; // ButonlarÄ± pasif yap
        cameraBtn.disabled = true;
        
        const formData = new FormData();
        formData.append('image_file', file);
        // SayÄ±m emri ID veya depo kodu OCR iÃ§in gerekli deÄŸilse kaldÄ±rÄ±labilir
        // formData.append('sayim_emri_id', SAYIM_EMRI_ID); 
        // formData.append('depo_kodu', DEPO_KODU);

        fetch('{% url "gemini_ocr_analiz" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
        })
        .then(res => {
             // Durum koduna gÃ¶re JSON parse etmeyi dene veya hata fÄ±rlat
             if (!res.ok) {
                 return res.json().then(errData => {
                      throw new Error(`Sunucu HatasÄ± (${res.status}): ${errData.message || 'Bilinmeyen YZ hatasÄ±'}`);
                 }).catch(() => {
                     // JSON yoksa genel hata
                      throw new Error(`Sunucu HatasÄ± (${res.status})`);
                 });
             }
             return res.json();
        })
        .then(data => {
            if (data.success && data.results?.length > 0) {
                showMessage('gemini_mesaj', data.message, 'success');
                topluSonucSayisi.innerText = data.count;
                
                data.results.forEach(item => {
                    const row = sonucTablosuBody.insertRow();
                    row.insertCell().innerHTML = `<p style="font-weight: bold; margin: 0;">${item.barkod !== 'YOK' ? item.barkod : item.stok_kod}</p><span style="font-size: 0.8em; color: gray;">${item.barkod === 'YOK' ? 'Sadece Kod' : 'Barkod'}</span>`;
                    const miktarCell = row.insertCell();
                    miktarCell.innerText = item.miktar;
                    miktarCell.style.textAlign = 'right';
                    miktarCell.style.fontWeight = 'bold';
                    row.insertCell().innerHTML = `<p style="margin: 0;">P: ${item.parti_no}</p><p style="margin: 0;">R: ${item.renk}</p>`;
                    
                    const islemBtn = document.createElement('button');
                    islemBtn.innerText = 'SEÃ‡';
                    islemBtn.onclick = function() {
                        barkodInput.value = item.barkod !== 'YOK' ? item.barkod : '';
                        stokKodInput.value = item.stok_kod !== 'YOK' ? item.stok_kod : '';
                        miktarInput.value = item.miktar;
                         // Parti ve Renk inputlarÄ±nÄ± bulup gÃ¼ncelle
                         const partiEl = document.getElementById('parti_no_input');
                         if(partiEl) partiEl.value = item.parti_no !== 'YOK' ? item.parti_no : '';
                         const renkEl = document.getElementById('renk_input');
                         if(renkEl) renkEl.value = item.renk !== 'YOK' ? item.renk : '';

                        // SeÃ§ilen Ã¼rÃ¼nÃ¼ otomatik ara (Barkod varsa barkodla, yoksa stokla)
                        akilliStokAra(
                            item.barkod !== 'YOK' ? item.barkod : 'YOK', 
                            item.barkod === 'YOK' ? item.stok_kod : 'YOK', // Barkod yoksa stokla ara
                            item.parti_no, 
                            item.renk, 
                            DEPO_KODU
                        );
                        // SeÃ§ilen satÄ±rÄ± vurgula
                         Array.from(sonucTablosuBody.rows).forEach(r => r.style.backgroundColor = '');
                         row.style.backgroundColor = '#e6f7ff';
                    };
                    row.insertCell().appendChild(islemBtn);
                });
                topluSonucAlani.style.display = 'block';

            } else {
                // BaÅŸarÄ±lÄ± ama sonuÃ§ yok veya success false ise
                showMessage('gemini_mesaj', data.message || 'GÃ¶rselde geÃ§erli etiket bulunamadÄ±.', 'warning');
            }
        })
        .catch(error => {
            console.error("Gemini Analiz HatasÄ±:", error);
            showMessage('gemini_mesaj', `âŒ YZ HatasÄ±: ${error.message}`, 'error');
        })
        .finally(() => {
             // ButonlarÄ± tekrar aktif yap
             selectFileBtn.disabled = false; 
             cameraBtn.disabled = false;
        });
    }

    // **********************************************
    // 4. KONUM ALMA (ASYNC)
    // **********************************************
    function getCurrentLocation() {
        return new Promise((resolve) => { // reject kaldÄ±rÄ±ldÄ±, her zaman Ã§Ã¶zÃ¼lecek
            if (!navigator.geolocation) {
                resolve({ latitude: 'YOK', longitude: 'YOK', error: 'TarayÄ±cÄ± desteklemiyor' });
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        error: null // BaÅŸarÄ±lÄ±
                    });
                },
                (error) => {
                    // Hata koduna gÃ¶re mesajÄ± belirle
                    let message = 'Konum alÄ±namadÄ±';
                    switch (error.code) {
                        case error.PERMISSION_DENIED: message = 'Konum izni reddedildi'; break;
                        case error.POSITION_UNAVAILABLE: message = 'Konum bilgisi mevcut deÄŸil'; break;
                        case error.TIMEOUT: message = 'Konum alma zaman aÅŸÄ±mÄ±na uÄŸradÄ±'; break;
                    }
                    resolve({ latitude: 'YOK', longitude: 'YOK', error: message });
                },
                { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 } // timeout sÃ¼resi ayarlandÄ±
            );
        });
    }


    // **********************************************
    // 5. SAYIM KAYDETME (AJAX POST)
    // **********************************************
    async function kaydetSayim() { // async yapÄ±ldÄ±
        const miktarValue = miktarInput.value;
        
        // --- KESÄ°N Ã‡Ã–ZÃœM: Benzersiz ID kontrolÃ¼ ---
        if (!currentBenzersizId) { 
            showMessage('kayit_mesaji', 'LÃ¼tfen Ã¶nce geÃ§erli bir stok arayÄ±n veya seÃ§in.', 'error');
            return;
        }
        // Miktar kontrolÃ¼
        let miktarDecimal;
        try {
             miktarDecimal = Decimal(miktarValue.replace(',', '.')); // VirgÃ¼lÃ¼ noktaya Ã§evir
             if (miktarDecimal.isNaN() || miktarDecimal.lte(0)) { // <= 0 kontrolÃ¼
                 throw new Error("Miktar sÄ±fÄ±rdan bÃ¼yÃ¼k olmalÄ±dÄ±r.");
             }
        } catch {
             showMessage('kayit_mesaji', 'GeÃ§ersiz miktar girdiniz. LÃ¼tfen sayÄ±sal bir deÄŸer girin (Ã¶rn: 1.00).', 'error');
             return;
        }

        showMessage('kayit_mesaji', 'Konum bilgisi alÄ±nÄ±yor...', 'info', 0); // KapanmasÄ±n
        kaydetBtn.disabled = true; // KayÄ±t sÄ±rasÄ±nda butonu pasif yap

        const locationData = await getCurrentLocation(); // Konumu al
        
        showMessage('kayit_mesaji', 'Kaydediliyor...', 'info', 0); 

        const dataToSend = {
            // --- KESÄ°N Ã‡Ã–ZÃœM: Benzersiz ID'yi gÃ¶nder ---
            benzersiz_id: currentBenzersizId, 
            miktar: miktarValue, // String olarak gÃ¶nder, backend Decimal'e Ã§evirir
            personel_adi: PERSONEL_ADI,
            lat: locationData.latitude,
            lon: locationData.longitude
            // Backend artÄ±k stok_kod, parti_no, renk, depo_kod'a ihtiyaÃ§ duymuyor
        };

        // Backend endpoint'i (re_path ile sonda / opsiyonel)
        const url = `/ajax/sayim-kaydet/${SAYIM_EMRI_ID}`; // DoÄŸrudan URL oluÅŸtur

        fetch(url, {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                'X-CSRFToken': getCookie('csrftoken'), 
            },
            body: JSON.stringify(dataToSend)
        })
        .then(res => {
             // Sunucu hatasÄ± durumunda JSON'u okumayÄ± dene
             if (!res.ok) {
                 return res.json().then(errData => {
                      throw new Error(`Sunucu HatasÄ± (${res.status}): ${errData.message || 'Bilinmeyen kayÄ±t hatasÄ±'}`);
                 }).catch(() => {
                      throw new Error(`Sunucu HatasÄ± (${res.status}). KayÄ±t baÅŸarÄ±sÄ±z.`);
                 });
             }
             return res.json();
        })
        .then(data => {
            if (data.success) {
                let successMessage = data.message;
                 // Konum hatasÄ± varsa uyarÄ±yÄ± mesaja ekle
                 if (locationData.error && locationData.error !== 'TarayÄ±cÄ± desteklemiyor') {
                     successMessage += ` (UyarÄ±: ${locationData.error})`;
                     showMessage('kayit_mesaji', successMessage, 'warning', 7000); // Daha uzun gÃ¶ster
                 } else {
                     showMessage('kayit_mesaji', successMessage, 'success');
                 }
                sayilanStokGoster.innerText = data.yeni_miktar || '0.00'; // ToplamÄ± gÃ¼ncelle
                miktarInput.value = ''; // Miktar alanÄ±nÄ± temizle
                barkodInput.focus(); // Barkod alanÄ±na geri odaklan (hÄ±zlÄ± giriÅŸ iÃ§in)
                barkodInput.select(); // Ä°Ã§eriÄŸi seÃ§
                
                // KayÄ±t sonrasÄ± Ã¼rÃ¼nÃ¼ sÄ±fÄ±rlayalÄ±m mÄ±? Yoksa aynÄ± Ã¼rÃ¼ne devam mÄ±?
                // Åimdilik sÄ±fÄ±rlamayalÄ±m, belki aynÄ± Ã¼rÃ¼nden tekrar girilecek.
                // resetUIBeforeSearch(); // Ä°sterseniz aktif edilebilir.
                
            } else {
                // Backend'den gelen hata mesajÄ±
                showMessage('kayit_mesaji', `HATA: ${data.message}`, 'error', 0); // KapanmasÄ±n
            }
        })
        .catch(error => {
            console.error("SayÄ±m Kaydetme HatasÄ±:", error);
            showMessage('kayit_mesaji', `Kritik KayÄ±t HatasÄ±: ${error.message}`, 'error', 0);
        })
        .finally(() => {
            // Hata olsa bile butonu tekrar aktif yap (eÄŸer Ã¼rÃ¼n hala seÃ§iliyse)
            if (currentBenzersizId) {
                kaydetBtn.disabled = false; 
            }
        });
    }

    // **********************************************
    // 6. OLAY DÄ°NLEYÄ°CÄ°LERÄ° KURULUMU
    // **********************************************
    function setupEventListeners() {
        // Arama Butonu
        araBtn.addEventListener('click', handleManualSearch);
        
        // Arama InputlarÄ± (Enter ve DeÄŸiÅŸim)
        setupAutoSearchListeners(); // Bu fonksiyon inputlarÄ± bulup dinleyici ekler

        // Miktar Input (Enter ile Kaydet)
        miktarInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Form gÃ¶ndermesini engelle
                kaydetSayim();
            }
        });

        // Kaydet Butonu
        kaydetBtn.addEventListener('click', kaydetSayim);

        // Gemini ButonlarÄ±
        selectFileBtn.addEventListener('click', () => {
             imageInput.removeAttribute('capture'); 
             imageInput.click();
         });
         cameraBtn.addEventListener('click', () => {
             imageInput.setAttribute('capture', 'environment'); 
             imageInput.click();
         });
         imageInput.addEventListener('change', function() {
             if (this.files && this.files.length > 0) {
                 geminiOku(this.files[0]); 
             }
             // capture attribute'unu temizle (her seferinde sormasÄ±n)
             this.value = null; // AynÄ± dosyayÄ± tekrar seÃ§ebilmek iÃ§in
             this.removeAttribute('capture'); 
         });
    }
    
    // Manuel Arama Butonu Ä°ÅŸleyicisi
    function handleManualSearch() {
        const stokKod = document.getElementById('stok_kod_input')?.value.toUpperCase().trim() || 'YOK';
        const partiNo = document.getElementById('parti_no_input')?.value.toUpperCase().trim() || 'YOK'; 
        const renk = document.getElementById('renk_input')?.value.toUpperCase().trim() || 'YOK';
        akilliStokAra('YOK', stokKod, partiNo, renk, DEPO_KODU);
    }

    // Input/Select iÃ§in Otomatik Arama Dinleyicileri
    function setupAutoSearchListeners() {
        const elementsToListen = [
            document.getElementById('barkod_input'), 
            document.getElementById('stok_kod_input'), 
            document.getElementById('parti_no_input'), 
            document.getElementById('renk_input')
        ];

        elementsToListen.forEach(input => {
            if (input) {
                // Ã–nceki dinleyicileri kaldÄ±r (varsa)
                input.removeEventListener('keydown', handleSearchTrigger);
                input.removeEventListener('change', handleSearchTrigger);
                
                // Yeni dinleyicileri ekle
                if (input.tagName === 'INPUT' && input.type === 'text') {
                    input.addEventListener('keydown', handleSearchTrigger);
                } else if (input.tagName === 'SELECT') {
                    input.addEventListener('change', handleSearchTrigger);
                }
            }
        });
    }

    // Arama Tetikleyici (Enter veya Select DeÄŸiÅŸimi)
    function handleSearchTrigger(event) {
        // Sadece Enter veya Select deÄŸiÅŸimi ise devam et
        if (event.type === 'keydown' && event.key !== 'Enter') return;
        
        // Enter ise varsayÄ±lan davranÄ±ÅŸÄ± engelle
        if (event.type === 'keydown') event.preventDefault(); 

        const sourceElementId = event.target.id;
        
        // Inputlardan gÃ¼ncel deÄŸerleri al
        const seriNoVal = document.getElementById('barkod_input')?.value.toUpperCase().trim() || 'YOK';
        const stokKodVal = document.getElementById('stok_kod_input')?.value.toUpperCase().trim() || 'YOK';
        const partiNoVal = document.getElementById('parti_no_input')?.value.toUpperCase().trim() || 'YOK';
        const renkVal = document.getElementById('renk_input')?.value.toUpperCase().trim() || 'YOK';

        // Hangi input tetiklediyse ona gÃ¶re arama yap
        if (sourceElementId === 'barkod_input') {
            akilliStokAra(seriNoVal, 'YOK', 'YOK', 'YOK', DEPO_KODU);
        } else {
             // Stok, Parti veya Renk deÄŸiÅŸtiyse
             akilliStokAra('YOK', stokKodVal, partiNoVal, renkVal, DEPO_KODU);
        }
    }


    // **********************************************
    // SAYFA YÃœKLENDÄ°ÄÄ°NDE BAÅLATMA
    // **********************************************
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elementlerini SeÃ§ ---
        barkodInput = document.getElementById('barkod_input');
        stokKodInput = document.getElementById('stok_kod_input');
        partiNoContainer = document.getElementById('parti_no_container');
        renkContainer = document.getElementById('renk_container');
        araBtn = document.getElementById('ara-btn');
        miktarInput = document.getElementById('miktar_input');
        kaydetBtn = document.getElementById('sayim_kaydet_btn');
        urunBilgiAlani = document.getElementById('urun_bilgi_alani');
        urunBilgi = document.getElementById('urun_bilgi');
        sistemStokGoster = document.getElementById('sistem_stok_goster');
        sayilanStokGoster = document.getElementById('sayilan_stok_goster');
        lastSayimGoster = document.getElementById('last_sayim_goster');
        farkliDepoUyariAlani = document.getElementById('farkli_depo_uyari_alani');
        kayitMesaji = document.getElementById('kayit_mesaji');
        geminiMesaj = document.getElementById('gemini_mesaj');
        topluSonucAlani = document.getElementById('toplu_sonuc_alani');
        topluSonucSayisi = document.getElementById('toplu_sonuc_sayisi');
        sonucTablosuBody = document.getElementById('sonuc_tablosu').getElementsByTagName('tbody')[0];
        imageInput = document.getElementById('image-input');
        selectFileBtn = document.getElementById('select-file-btn');
        cameraBtn = document.getElementById('camera-btn');

        // --- BaÅŸlangÄ±Ã§ DeÄŸerlerini Ayarla ---
        DEPO_KODU = document.getElementById('depo_kodu_gizli').innerText.trim();
        PERSONEL_ADI = document.getElementById('personel_adi_gizli').innerText.trim();
        
        // --- Olay Dinleyicilerini Kur ---
        setupEventListeners();

        // --- Sayfa YÃ¼klendiÄŸinde Ä°lk BoÅŸ AramayÄ± Yap (isteÄŸe baÄŸlÄ±) ---
        // akilliStokAra('YOK', 'YOK', 'YOK', 'YOK', DEPO_KODU); 
        // Veya barkod inputuna odaklan
         barkodInput.focus();
    });
</script>
</body>
</html>

